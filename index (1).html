<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üå∏ Flower Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0b0b1a;font-family:'Outfit','Segoe UI',sans-serif;color:#e0e6f0}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
.wrap{max-width:1100px;margin:0 auto;padding:16px 14px}
.header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:14px}
.logo{font-size:20px;font-weight:800;background:linear-gradient(135deg,#E8446D,#F7944A);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.upd{color:#5a6580;font-size:10px;margin-top:3px}
.filters{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.btn{padding:6px 13px;border-radius:8px;border:1px solid rgba(255,255,255,.06);font-size:11.5px;font-weight:600;cursor:pointer;background:transparent;color:#5a6580;font-family:inherit;transition:.2s}
.btn.on{color:#fff;border-color:transparent}
.b0.on{background:linear-gradient(135deg,#E8446D,#F7944A)}.b1.on{background:#4A6CF7}.b2.on{background:#E8446D}
select{padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.06);font-size:11.5px;background:#141425;color:#e0e6f0;cursor:pointer;outline:none;font-family:inherit}
.tabs{display:flex;border-bottom:2px solid rgba(255,255,255,.06);margin-bottom:18px}
.tab{padding:10px 20px;border:none;cursor:pointer;font-size:13px;font-weight:700;background:none;color:#5a6580;border-bottom:3px solid transparent;margin-bottom:-2px;font-family:inherit}
.tab.on{color:#e0e6f0;border-bottom-color:#E8446D}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px}
.kpi{background:linear-gradient(135deg,#141425,#1a1a30);border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,.06);position:relative;overflow:hidden}
.kpi-d{position:absolute;top:-15px;right:-15px;width:55px;height:55px;border-radius:50%;opacity:.1}
.kpi-l{color:#5a6580;font-size:10px;letter-spacing:1px;text-transform:uppercase}
.kpi-v{font-size:22px;font-weight:700;margin:5px 0 2px}
.kpi-s{color:#5a6580;font-size:11px}
.card{background:linear-gradient(135deg,#141425,#1a1a30);border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,.06);margin-bottom:14px}
.st{font-size:14px;font-weight:700;margin:24px 0 10px;border-bottom:1px solid rgba(255,255,255,.06);padding-bottom:8px}
.g2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
.ch{position:relative;height:220px}
.ri{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06)}.ri:last-child{border-bottom:none}
.rn{width:24px;height:24px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;background:rgba(255,255,255,.05);color:#5a6580}
.rn.g{background:linear-gradient(135deg,#F1C40F,#F7944A);color:#fff}
table{width:100%;font-size:11.5px;min-width:750px}
th{padding:8px 6px;text-align:right;color:#5a6580;font-weight:600;font-size:10px;border-bottom:2px solid #4A6CF7}
th:first-child{text-align:left}td{padding:7px 6px;text-align:right;border-bottom:1px solid rgba(255,255,255,.06)}
td:first-child{text-align:left;font-weight:600}tr:nth-child(even){background:rgba(255,255,255,.015)}
.tsc{overflow-x:auto}
.em{text-align:center;padding:50px;color:#5a6580}
.su{max-width:550px;margin:60px auto;padding:0 20px}
.su h1{font-size:28px;font-weight:800;text-align:center;margin-bottom:8px}
.su .sb{color:#5a6580;text-align:center;margin-bottom:30px;font-size:13px}
.su label{display:block;font-size:12px;font-weight:600;margin-bottom:6px}
.su input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.06);background:#141425;color:#e0e6f0;font-size:13px;outline:none;font-family:inherit;margin-bottom:4px}
.su .ht{color:#5a6580;font-size:10px;margin-bottom:16px}.su .ht b{color:#4A6CF7}
.gb{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(135deg,#E8446D,#F7944A);color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:8px}
.wb{background:rgba(247,148,74,.08);border:1px solid rgba(247,148,74,.2);border-radius:12px;padding:14px;margin-bottom:20px}
.wb p{font-size:12px;margin:0 0 3px}.wb .t{color:#F7944A;font-weight:700;margin-bottom:10px}
#pg{display:none}
</style>
</head>
<body>
<div id="su" class="su">
  <h1>üå∏ Flower Dashboard</h1>
  <p class="sb">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –≤–∞—à–∏ Google –¢–∞–±–ª–∏—Ü—ã</p>
  <div class="wb"><p class="t">‚ö†Ô∏è –°–ù–ê–ß–ê–õ–ê: –û–ø—É–±–ª–∏–∫—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã</p><p>–í –∫–∞–∂–¥–æ–π Google –¢–∞–±–ª–∏—Ü–µ:</p><p>1. –§–∞–π–ª ‚Üí –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ</p><p>2. –í—ã–±–µ—Ä–∏—Ç–µ ¬´–í–µ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç¬ª</p><p>3. –ù–∞–∂–º–∏—Ç–µ ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å¬ª</p></div>
  <label>ID —Ç–∞–±–ª–∏—Ü—ã –ê—Å—Ç–∞–Ω–∞</label><input id="ia" placeholder="1AbCdEfGhIjKl..."><p class="ht">–ò–∑ URL: /spreadsheets/d/<b>–≠–¢–û–¢_ID</b>/edit</p>
  <label>ID —Ç–∞–±–ª–∏—Ü—ã –ê–ª–º–∞—Ç—ã</label><input id="ib" placeholder="1XyZaBcDeFgHi..."><p class="ht">–ò–∑ URL: /spreadsheets/d/<b>–≠–¢–û–¢_ID</b>/edit</p>
  <button class="gb" onclick="go()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å ‚Üí</button>
</div>
<div id="pg"><div class="wrap">
  <div class="header"><div><div class="logo">üå∏ Flower Dashboard</div><div class="upd" id="ut"></div></div>
    <div class="filters">
      <button class="btn b0 on" onclick="sC('–í—Å–µ')">–í—Å–µ</button><button class="btn b1" onclick="sC('–ê—Å—Ç–∞–Ω–∞')">–ê—Å—Ç–∞–Ω–∞</button><button class="btn b2" onclick="sC('–ê–ª–º–∞—Ç—ã')">–ê–ª–º–∞—Ç—ã</button>
      <select id="ms" onchange="sM(+this.value)"><option value="-1">–í—Å–µ –º–µ—Å—è—Ü—ã</option></select>
      <button class="btn" style="color:#44C9A1" onclick="ld()">üîÑ</button>
      <button class="btn" onclick="back()">‚öôÔ∏è</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab on" data-t="sales" onclick="sT('sales')">üìä –ü—Ä–æ–¥–∞–∂–∏</button>
    <button class="tab" data-t="mkt" onclick="sT('mkt')">üéØ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</button>
    <button class="tab" data-t="fin" onclick="sT('fin')">üí∞ –§–∏–Ω–∞–Ω—Å—ã</button>
  </div>
  <div id="ct"></div>
</div></div>
<script>
var CF={a:'',b:''},S=[],E=[],M=[],cC='–í—Å–µ',cM=-1,cT='sales',ch=[];
var MN=["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
var SM=["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"];
function nm(v){if(!v)return 0;var s=String(v).replace(/[^\d.\-]/g,'');return parseFloat(s)||0;}
function gm(v){if(!v)return-1;var p=v.split('.');return p.length>=2?parseInt(p[1])-1:-1;}
function ft(x){return Math.abs(x)>=1e6?(x/1e6).toFixed(1)+'–ú':Math.abs(x)>=1e3?Math.round(x/1e3)+'–ö':Math.round(x)+'';}
function ff(x){return new Intl.NumberFormat('ru-RU').format(Math.round(x))+' ‚Ç∏';}
function cl(t){var l=t.split('\n').filter(function(x){return x.trim()});if(l.length<2)return[];var h=cp(l[0]);return l.slice(1).map(function(x){var v=cp(x),o={};h.forEach(function(k,i){o[k.replace(/^"|"$/g,'').trim()]=(v[i]||'').replace(/^"|"$/g,'').trim()});return o})}
function cp(l){var r=[],c='',q=false;for(var i=0;i<l.length;i++){var x=l[i];if(x==='"')q=!q;else if(x===','&&!q){r.push(c);c='';}else c+=x;}r.push(c);return r}
function kp(l,v,s,c){return'<div class="kpi"><div class="kpi-d" style="background:'+c+'"></div><div class="kpi-l">'+l+'</div><div class="kpi-v">'+v+'</div>'+(s?'<div class="kpi-s">'+s+'</div>':'')+'</div>';}

function ld(){
  var btn=document.querySelector('[onclick="ld()"]');btn.textContent='‚è≥';
  S=[];E=[];M=[];
  var tasks=[];
  [['–ê—Å—Ç–∞–Ω–∞',CF.a],['–ê–ª–º–∞—Ç—ã',CF.b]].forEach(function(x){
    var city=x[0],id=x[1];if(!id)return;
    tasks.push(fetch('https://docs.google.com/spreadsheets/d/'+id+'/gviz/tq?tqx=out:csv&sheet='+encodeURIComponent('–ü—Ä–æ–¥–∞–∂–∏')).then(function(r){return r.ok?r.text():''}).then(function(t){if(!t)return;cl(t).forEach(function(r){var k=Object.keys(r);S.push({c:city,d:r[k[0]],n:r[k[1]],sh:r[k[2]],l:nm(r[k[3]]),o:nm(r[k[4]]),kp:nm(r[k[5]]),kr:nm(r[k[6]]),ca:nm(r[k[7]]),hk:nm(r[k[8]])+nm(r[k[9]]),ot:nm(r[k[10]])+nm(r[k[11]])+nm(r[k[12]])+nm(r[k[13]])+nm(r[k[14]])+nm(r[k[15]])+nm(r[k[16]]),t:nm(r[k[19]])})})}).catch(function(){}));
    tasks.push(fetch('https://docs.google.com/spreadsheets/d/'+id+'/gviz/tq?tqx=out:csv&sheet='+encodeURIComponent('–†–∞—Å—Ö–æ–¥—ã')).then(function(r){return r.ok?r.text():''}).then(function(t){if(!t)return;cl(t).forEach(function(r){var k=Object.keys(r);E.push({c:city,d:r[k[0]],n:r[k[1]],a:nm(r[k[2]]),cat:r[k[3]]||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'})})}).catch(function(){}));
    tasks.push(fetch('https://docs.google.com/spreadsheets/d/'+id+'/gviz/tq?tqx=out:csv&sheet='+encodeURIComponent('–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥')).then(function(r){return r.ok?r.text():''}).then(function(t){if(!t)return;cl(t).forEach(function(r){var k=Object.keys(r);M.push({c:city,d:r[k[0]],p:nm(r[k[1]]),l:nm(r[k[2]]),sp:nm(r[k[4]]),sl:nm(r[k[6]]),pr:nm(r[k[9]]),b:nm(r[k[11]])})})}).catch(function(){}));
  });
  Promise.all(tasks).then(function(){
    S=S.filter(function(x){return x.d});E=E.filter(function(x){return x.d});M=M.filter(function(x){return x.d});
    btn.textContent='üîÑ';document.getElementById('ut').textContent='–û–±–Ω–æ–≤–ª–µ–Ω–æ: '+new Date().toLocaleTimeString('ru')+' ‚Ä¢ –∞–≤—Ç–æ 5–º–∏–Ω';
    var ms=new Set();S.forEach(function(x){var m=gm(x.d);if(m>=0)ms.add(m)});M.forEach(function(x){var m=gm(x.d);if(m>=0)ms.add(m)});
    var sel=document.getElementById('ms');sel.innerHTML='<option value="-1">–í—Å–µ –º–µ—Å—è—Ü—ã</option>';
    Array.from(ms).sort().forEach(function(m){sel.innerHTML+='<option value="'+m+'">'+MN[m]+'</option>'});
    rr();
  });
}

function fi(a){var r=a;if(cC!=='–í—Å–µ')r=r.filter(function(x){return x.c===cC});if(cM!==-1)r=r.filter(function(x){return gm(x.d)===cM});return r;}
function sC(c){cC=c;document.querySelectorAll('.b0,.b1,.b2').forEach(function(b){b.classList.remove('on')});document.querySelector(c==='–í—Å–µ'?'.b0':c==='–ê—Å—Ç–∞–Ω–∞'?'.b1':'.b2').classList.add('on');rr();}
function sM(m){cM=m;rr();}
function sT(t){cT=t;document.querySelectorAll('.tab').forEach(function(b){b.classList.remove('on')});document.querySelector('[data-t="'+t+'"]').classList.add('on');rr();}
function dc(){ch.forEach(function(c){try{c.destroy()}catch(e){}});ch=[];}

function rr(){dc();var el=document.getElementById('ct');if(cT==='sales')rS(el);else if(cT==='mkt')rM(el);else rF(el);}

function rS(el){
  var d=fi(S),rev=0,lds=0,ord=0;d.forEach(function(x){rev+=x.t;lds+=x.l;ord+=x.o});
  var cv=lds?ord/lds:0,av=ord?Math.round(rev/ord):0;
  var h='<div class="kpis">'+kp('–í—ã—Ä—É—á–∫–∞',ft(rev)+'‚Ç∏','','#4A6CF7')+kp('–õ–∏–¥—ã',lds,'–≤—Ö–æ–¥—è—â–∏–µ','#F7944A')+kp('–ü—Ä–æ–¥–∞–∂–∏',ord,'–∫–æ–Ω–≤. '+(cv*100).toFixed(1)+'%','#44C9A1')+kp('–°—Ä. —á–µ–∫',ff(av),'','#9B59B6')+'</div>';
  h+='<div class="st">–í—ã—Ä—É—á–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</div><div class="card"><div class="ch"><canvas id="c1"></canvas></div></div>';
  h+='<div class="g2"><div><div class="st">–¢–æ–ø –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</div><div class="card" id="rk"></div></div>';
  h+='<div><div class="st">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</div><div class="card"><div class="ch"><canvas id="c2"></canvas></div></div></div></div>';
  if(!d.length)h+='<div class="card em">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
  el.innerHTML=h;
  var bm=SM.map(function(_,i){return S.filter(function(x){return(cC==='–í—Å–µ'||x.c===cC)&&gm(x.d)===i}).reduce(function(s,x){return s+x.t},0)});
  var lb=[],vl=[];SM.forEach(function(m,i){if(bm[i]>0){lb.push(m);vl.push(bm[i])}});
  if(vl.length){ch.push(new Chart(document.getElementById('c1'),{type:'bar',data:{labels:lb,datasets:[{label:'–í—ã—Ä—É—á–∫–∞',data:vl,backgroundColor:'#4A6CF7',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(c){return ff(c.raw)}}}},scales:{x:{ticks:{color:'#5a6580'},grid:{display:false}},y:{ticks:{color:'#5a6580',callback:function(v){return ft(v)}},grid:{color:'rgba(255,255,255,.04)'}}}}}));}
  var mg={};d.forEach(function(x){mg[x.n]=(mg[x.n]||0)+x.t});var tp=Object.entries(mg).sort(function(a,b){return b[1]-a[1]});
  var rk=document.getElementById('rk');if(rk)rk.innerHTML=tp.map(function(x,i){return'<div class="ri"><span class="rn'+(i===0?' g':'')+'">'+( i+1)+'</span><span style="flex:1;font-weight:600;font-size:13px">'+x[0]+'</span><span style="font-weight:700;font-size:13px">'+ft(x[1])+'‚Ç∏</span></div>'}).join('')||'<div class="em">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
  var py={};d.forEach(function(x){py['Kaspi Pay']=(py['Kaspi Pay']||0)+x.kp;py['Kaspi Red']=(py['Kaspi Red']||0)+x.kr;py['–ù–∞–ª–∏—á–Ω—ã–µ']=(py['–ù–∞–ª–∏—á–Ω—ã–µ']||0)+x.ca;py['–•–∞–ª—ã–∫']=(py['–•–∞–ª—ã–∫']||0)+x.hk;py['–î—Ä—É–≥–∏–µ']=(py['–î—Ä—É–≥–∏–µ']||0)+x.ot});
  var pl=[],pv=[];Object.keys(py).forEach(function(k){if(py[k]>0){pl.push(k);pv.push(py[k])}});
  if(pv.length){ch.push(new Chart(document.getElementById('c2'),{type:'doughnut',data:{labels:pl,datasets:[{data:pv,backgroundColor:['#4A6CF7','#E8446D','#44C9A1','#F7944A','#9B59B6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{callbacks:{label:function(c){return ff(c.raw)}}},legend:{position:'bottom',labels:{color:'#5a6580',font:{size:10}}}}}}));}
}

function rM(el){
  var d=fi(M),tl=0,tp=0,ts=0,tb=0,tpr=0,tsp=0;d.forEach(function(x){tl+=x.l;tp+=x.p;ts+=x.sl;tb+=x.b;tpr+=x.pr;tsp+=x.sp});
  var rm=tb?(tpr/tb*100):0,cp2=tl?tsp/tl:0;
  var h='<div class="kpis">'+kp('–õ–∏–¥—ã',tl,'–ø–ª–∞–Ω '+tp,'#4A6CF7')+kp('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ',(tp?tl/tp*100:0).toFixed(0)+'%','','#44C9A1')+kp('–¶–µ–Ω–∞/–ª–∏–¥','$'+cp2.toFixed(2),'','#F7944A')+kp('–ü—Ä–æ–¥–∞–∂–∏',ts,'','#44C9A1')+kp('–ë—é–¥–∂–µ—Ç',ff(tb),'','#E8446D')+kp('ROMI',rm.toFixed(0)+'%','',rm>300?'#44C9A1':'#E8446D')+'</div>';
  var rows=cM===-1?SM.map(function(m,i){var md=M.filter(function(x){return(cC==='–í—Å–µ'||x.c===cC)&&gm(x.d)===i});if(!md.length)return null;var lp=0,l=0,sp=0,sl=0,bk=0,pr=0;md.forEach(function(x){lp+=x.p;l+=x.l;sp+=x.sp;sl+=x.sl;bk+=x.b;pr+=x.pr});return{lb:MN[i],plan:lp,leads:l,comp:lp?(l/lp*100).toFixed(1):0,spent:sp,cpl:l?(sp/l).toFixed(2):0,sales:sl,cps:sl?(sp/sl).toFixed(2):0,conv:l?(sl/l*100).toFixed(1):0,profit:pr,budget:bk,romi:bk?(pr/bk*100).toFixed(1):0}}).filter(Boolean):d.map(function(x){return{lb:x.d,plan:x.p,leads:x.l,comp:x.p?(x.l/x.p*100).toFixed(1):0,spent:x.sp,cpl:x.l?(x.sp/x.l).toFixed(2):0,sales:x.sl,cps:x.sl?(x.sp/x.sl).toFixed(2):0,conv:x.l?(x.sl/x.l*100).toFixed(1):0,profit:x.pr,budget:x.b,romi:x.b?(x.pr/x.b*100).toFixed(1):0}});
  if(rows.length){h+='<div class="st">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç</div><div class="card"><div class="tsc"><table><thead><tr><th style="text-align:left"></th><th>–ü–ª–∞–Ω</th><th>–õ–∏–¥—ã</th><th>–í—ã–ø.%</th><th>$</th><th>$/–ª–∏–¥</th><th>–ü—Ä–æ–¥.</th><th>$/–ø—Ä–æ–¥.</th><th>–ö–æ–Ω–≤.%</th><th>–ü—Ä–∏–±—ã–ª—å</th><th>–ë—é–¥–∂–µ—Ç‚Ç∏</th><th>ROMI</th></tr></thead><tbody>';
    rows.forEach(function(r){var cc=r.comp>=90?'#44C9A1':r.comp>=75?'#F1C40F':'#E8446D',rc=r.romi>400?'#44C9A1':r.romi>200?'#F1C40F':'#E8446D',pc=r.profit>0?'#44C9A1':'#E8446D';
      h+='<tr><td>'+r.lb+'</td><td>'+r.plan+'</td><td style="font-weight:600">'+r.leads+'</td><td style="color:'+cc+';font-weight:600">'+r.comp+'%</td><td>$'+r.spent+'</td><td style="font-weight:600">$'+r.cpl+'</td><td style="font-weight:600">'+r.sales+'</td><td>$'+r.cps+'</td><td>'+r.conv+'%</td><td style="color:'+pc+';font-weight:600">'+new Intl.NumberFormat('ru').format(r.profit)+'‚Ç∏</td><td>'+new Intl.NumberFormat('ru').format(r.budget)+'‚Ç∏</td><td style="color:'+rc+';font-weight:700;font-size:13px">'+r.romi+'%</td></tr>'});
    h+='</tbody></table></div></div>';}
  if(!d.length)h+='<div class="card em">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
  el.innerHTML=h;
}

function rF(el){
  var sd=fi(S),ed=fi(E),md=fi(M),rev=0,exp=0,tgt=0;
  sd.forEach(function(x){rev+=x.t});ed.forEach(function(x){exp+=x.a});md.forEach(function(x){tgt+=x.b});
  var net=rev-exp-tgt;
  var h='<div class="kpis">'+kp('–í—ã—Ä—É—á–∫–∞',ft(rev)+'‚Ç∏','','#4A6CF7')+kp('–†–∞—Å—Ö–æ–¥—ã',ft(exp)+'‚Ç∏','','#E8446D')+kp('–¢–∞—Ä–≥–µ—Ç',ft(tgt)+'‚Ç∏','','#F1C40F')+kp('–ü—Ä–∏–±—ã–ª—å',ft(net)+'‚Ç∏',rev?'–º–∞—Ä–∂–∞ '+(net/rev*100).toFixed(0)+'%':'',net>0?'#44C9A1':'#E8446D')+'</div>';
  h+='<div class="g2"><div><div class="st">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div><div class="card"><div class="ch"><canvas id="c3"></canvas></div></div></div>';
  h+='<div><div class="st">–ü—Ä–∏–±—ã–ª—å –ø–æ –º–µ—Å—è—Ü–∞–º</div><div class="card"><div class="ch"><canvas id="c4"></canvas></div></div></div></div>';
  el.innerHTML=h;
  var ct={};ed.forEach(function(x){ct[x.cat]=(ct[x.cat]||0)+x.a});var cL=[],cV=[];Object.keys(ct).sort(function(a,b){return ct[b]-ct[a]}).forEach(function(k){cL.push(k);cV.push(ct[k])});
  if(cV.length){ch.push(new Chart(document.getElementById('c3'),{type:'doughnut',data:{labels:cL,datasets:[{data:cV,backgroundColor:['#E8446D','#4A6CF7','#44C9A1','#F7944A','#9B59B6','#F1C40F','#95A5A6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:{callbacks:{label:function(c){return ff(c.raw)}}},legend:{position:'bottom',labels:{color:'#5a6580',font:{size:10}}}}}}));}
  var aS=cC==='–í—Å–µ'?S:S.filter(function(x){return x.c===cC}),aE=cC==='–í—Å–µ'?E:E.filter(function(x){return x.c===cC}),aM=cC==='–í—Å–µ'?M:M.filter(function(x){return x.c===cC});
  var lb=[],dR=[],dE=[],dP=[];SM.forEach(function(m,i){var sr=aS.filter(function(x){return gm(x.d)===i}).reduce(function(s,x){return s+x.t},0),er=aE.filter(function(x){return gm(x.d)===i}).reduce(function(s,x){return s+x.a},0),tr=aM.filter(function(x){return gm(x.d)===i}).reduce(function(s,x){return s+x.b},0);if(sr||er){lb.push(m);dR.push(sr);dE.push(er+tr);dP.push(sr-er-tr)}});
  if(lb.length){ch.push(new Chart(document.getElementById('c4'),{type:'bar',data:{labels:lb,datasets:[{label:'–í—ã—Ä—É—á–∫–∞',data:dR,backgroundColor:'#4A6CF7',borderRadius:4},{label:'–†–∞—Å—Ö–æ–¥—ã',data:dE,backgroundColor:'#E8446D',borderRadius:4},{label:'–ü—Ä–∏–±—ã–ª—å',data:dP,backgroundColor:'#44C9A1',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#5a6580',font:{size:11}}},tooltip:{callbacks:{label:function(c){return c.dataset.label+': '+ff(c.raw)}}}},scales:{x:{ticks:{color:'#5a6580'},grid:{display:false}},y:{ticks:{color:'#5a6580',callback:function(v){return ft(v)}},grid:{color:'rgba(255,255,255,.04)'}}}}}));}
}

function go(){var a=document.getElementById('ia').value.trim(),b=document.getElementById('ib').value.trim();if(!a&&!b){alert('–í–≤–µ–¥–∏—Ç–µ ID');return;}CF={a:a,b:b};try{localStorage.setItem('fc',JSON.stringify(CF))}catch(e){}document.getElementById('su').style.display='none';document.getElementById('pg').style.display='block';ld();}
function back(){document.getElementById('su').style.display='block';document.getElementById('pg').style.display='none';document.getElementById('ia').value=CF.a;document.getElementById('ib').value=CF.b;}
try{var s=localStorage.getItem('fc');if(s){CF=JSON.parse(s);document.getElementById('ia').value=CF.a;document.getElementById('ib').value=CF.b;if(CF.a||CF.b){document.getElementById('su').style.display='none';document.getElementById('pg').style.display='block';ld();}}}catch(e){}
setInterval(function(){if(CF.a||CF.b)ld()},300000);
</script>
</body>
</html>
