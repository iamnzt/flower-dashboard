<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üå∏ Flower Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0b0b1a; font-family: 'Outfit', 'Segoe UI', sans-serif; color: #e0e6f0; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
input, select, button { font-family: inherit; }
table { border-collapse: collapse; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;
const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, LineChart, Line, Legend } = Recharts;

const SHEETS_URL = (id, sheet) => `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;

function parseCSV(text) {
  const lines = text.split('\n').filter(l => l.trim());
  if (lines.length < 2) return [];
  const headers = csvLine(lines[0]);
  return lines.slice(1).map(line => {
    const vals = csvLine(line);
    const obj = {};
    headers.forEach((h, i) => { obj[h.replace(/^"|"$/g,'').trim()] = (vals[i]||'').replace(/^"|"$/g,'').trim(); });
    return obj;
  });
}
function csvLine(line) {
  const r=[]; let c='', q=false;
  for(let i=0;i<line.length;i++){const ch=line[i]; if(ch==='"')q=!q; else if(ch===','&&!q){r.push(c);c='';}else c+=ch;}
  r.push(c); return r;
}
function num(v){if(!v)return 0; const n=parseFloat(String(v).replace(/[^\d.-]/g,'').replace(',','.')); return isNaN(n)?0:n;}
function parseDate(v){if(!v)return null; const p=v.split('.'); if(p.length>=2){let d=parseInt(p[0]),m=parseInt(p[1])-1,y=p[2]?parseInt(p[2]):new Date().getFullYear(); if(y<100)y+=2000; return new Date(y,m,d);} return null;}
function getMonth(v){const d=parseDate(v); return d?d.getMonth():-1;}

const MNAMES=["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
const SM=["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"];
const C={bg:"#0b0b1a",card:"linear-gradient(135deg,#141425 0%,#1a1a30 100%)",border:"rgba(255,255,255,0.06)",text:"#e0e6f0",muted:"#5a6580",a1:"#E8446D",a2:"#4A6CF7",a3:"#44C9A1",a4:"#F7944A",a5:"#9B59B6",a6:"#F1C40F"};
const fmt=n=>{if(Math.abs(n)>=1e6)return(n/1e6).toFixed(1)+"–ú";if(Math.abs(n)>=1e3)return Math.round(n/1e3)+"–ö";return String(Math.round(n));};
const fmtF=n=>new Intl.NumberFormat("ru-RU").format(Math.round(n))+" ‚Ç∏";

const Card=({children,style})=>React.createElement('div',{style:{background:C.card,borderRadius:14,padding:16,border:`1px solid ${C.border}`,...style}},children);
const KPI=({label,value,sub,color=C.a2})=>React.createElement(Card,{style:{position:"relative",overflow:"hidden",minWidth:130}},
  React.createElement('div',{style:{position:"absolute",top:-15,right:-15,width:55,height:55,borderRadius:"50%",background:color,opacity:.1}}),
  React.createElement('p',{style:{color:C.muted,fontSize:10,margin:0,letterSpacing:1,textTransform:"uppercase"}},label),
  React.createElement('p',{style:{color:C.text,fontSize:22,margin:"5px 0 2px",fontWeight:700}},value),
  sub&&React.createElement('span',{style:{color:C.muted,fontSize:11}},sub));
const Ttl=({children})=>React.createElement('h3',{style:{color:C.text,fontSize:14,fontWeight:700,margin:"24px 0 10px",borderBottom:`1px solid ${C.border}`,paddingBottom:8}},children);

const TT=({active,payload,label})=>{
  if(!active||!payload)return null;
  return React.createElement('div',{style:{background:"#141425",border:`1px solid ${C.border}`,borderRadius:10,padding:"8px 12px",boxShadow:"0 8px 32px rgba(0,0,0,.5)"}},
    React.createElement('p',{style:{color:"#888",fontSize:11,margin:0}},label),
    payload.map((p,i)=>React.createElement('p',{key:i,style:{color:p.color||p.fill,fontSize:12,margin:"2px 0 0",fontWeight:600}},p.name,": ",typeof p.value==="number"&&Math.abs(p.value)>100?fmtF(p.value):p.value)));
};

// ============ SETTINGS ============
function Settings({config,setConfig,onSave}){
  const [local,setLocal]=useState(config);
  return React.createElement('div',{style:{maxWidth:550,margin:"60px auto",padding:"0 20px"}},
    React.createElement('h1',{style:{color:C.text,fontSize:28,fontWeight:800,textAlign:"center",margin:"0 0 8px"}},"üå∏ Flower Dashboard"),
    React.createElement('p',{style:{color:C.muted,textAlign:"center",margin:"0 0 30px",fontSize:13}},"–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Google –¢–∞–±–ª–∏—Ü—ã"),
    React.createElement(Card,{style:{marginBottom:20}},
      React.createElement('p',{style:{color:C.a4,fontSize:12,fontWeight:700,margin:"0 0 10px"}},"‚ö†Ô∏è –°–ù–ê–ß–ê–õ–ê: –û–ø—É–±–ª–∏–∫—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã"),
      React.createElement('p',{style:{color:C.text,fontSize:12,margin:"0 0 3px"}},"–í –∫–∞–∂–¥–æ–π Google –¢–∞–±–ª–∏—Ü–µ:"),
      React.createElement('p',{style:{color:C.text,fontSize:12,margin:"0 0 3px"}},"1. –§–∞–π–ª ‚Üí –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ"),
      React.createElement('p',{style:{color:C.text,fontSize:12,margin:"0 0 3px"}},"2. –í—ã–±–µ—Ä–∏—Ç–µ ¬´–í–µ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç¬ª"),
      React.createElement('p',{style:{color:C.text,fontSize:12,margin:0}},"3. –ù–∞–∂–º–∏—Ç–µ ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å¬ª")),
    ["astanaId","almatyId"].map(k=>React.createElement('div',{key:k,style:{marginBottom:16}},
      React.createElement('label',{style:{color:C.text,fontSize:12,fontWeight:600,display:"block",marginBottom:6}},k==="astanaId"?"ID —Ç–∞–±–ª–∏—Ü—ã –ê—Å—Ç–∞–Ω–∞":"ID —Ç–∞–±–ª–∏—Ü—ã –ê–ª–º–∞—Ç—ã"),
      React.createElement('input',{value:local[k]||'',onChange:e=>setLocal({...local,[k]:e.target.value}),placeholder:"1AbCdEf...",
        style:{width:"100%",padding:"10px 12px",borderRadius:10,border:`1px solid ${C.border}`,background:"#141425",color:C.text,fontSize:13,outline:"none",boxSizing:"border-box"}}),
      React.createElement('p',{style:{color:C.muted,fontSize:10,margin:"4px 0 0"}},"–ò–∑ URL: /spreadsheets/d/",React.createElement('b',{style:{color:C.a2}},"–≠–¢–û–¢_ID"),"/edit"))),
    React.createElement('button',{onClick:()=>{setConfig(local);onSave(local);},
      style:{width:"100%",padding:"12px",borderRadius:10,border:"none",background:`linear-gradient(135deg,${C.a1},${C.a4})`,color:"#fff",fontSize:14,fontWeight:700,cursor:"pointer",marginTop:8}},
      "–ü–æ–¥–∫–ª—é—á–∏—Ç—å ‚Üí"));
}

// ============ SALES ============
function SalesPage({data,month}){
  const f=month===-1?data:data.filter(d=>getMonth(d.date)===month);
  const rev=f.reduce((s,d)=>s+d.total,0), leads=f.reduce((s,d)=>s+d.leads,0), orders=f.reduce((s,d)=>s+d.orders,0);
  const conv=leads?orders/leads:0, avg=orders?Math.round(rev/orders):0;
  const byM=SM.map((m,i)=>{const md=data.filter(d=>getMonth(d.date)===i);return{month:m,–í—ã—Ä—É—á–∫–∞:md.reduce((s,d)=>s+d.total,0)};}).filter(d=>d.–í—ã—Ä—É—á–∫–∞>0);
  const mgr={};f.forEach(d=>{mgr[d.name]=(mgr[d.name]||0)+d.total;});
  const top=Object.entries(mgr).sort((a,b)=>b[1]-a[1]).map(([n,r])=>({name:n,rev:r}));
  const pay={"Kaspi Pay":0,"Kaspi Red":0,"–ù–∞–ª–∏—á–Ω—ã–µ":0,"–•–∞–ª—ã–∫":0,"–î—Ä—É–≥–∏–µ":0};
  f.forEach(d=>{pay["Kaspi Pay"]+=d.kp;pay["Kaspi Red"]+=d.kr;pay["–ù–∞–ª–∏—á–Ω—ã–µ"]+=d.ca;pay["–•–∞–ª—ã–∫"]+=d.hk;pay["–î—Ä—É–≥–∏–µ"]+=d.ot;});
  const pd=Object.entries(pay).filter(([,v])=>v>0).map(([n,v])=>({name:n,value:v}));
  const pc=[C.a2,C.a1,C.a3,C.a4,C.a5];

  return React.createElement('div',null,
    React.createElement('div',{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:10}},
      React.createElement(KPI,{label:"–í—ã—Ä—É—á–∫–∞",value:fmt(rev)+"‚Ç∏",color:C.a2}),
      React.createElement(KPI,{label:"–õ–∏–¥—ã",value:leads,sub:"–≤—Ö–æ–¥—è—â–∏–µ",color:C.a4}),
      React.createElement(KPI,{label:"–ü—Ä–æ–¥–∞–∂–∏",value:orders,sub:`–∫–æ–Ω–≤. ${(conv*100).toFixed(1)}%`,color:C.a3}),
      React.createElement(KPI,{label:"–°—Ä. —á–µ–∫",value:fmtF(avg),color:C.a5})),
    byM.length>0&&React.createElement(React.Fragment,null,
      React.createElement(Ttl,null,"–í—ã—Ä—É—á–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º"),
      React.createElement(Card,null,React.createElement(ResponsiveContainer,{width:"100%",height:220},
        React.createElement(BarChart,{data:byM},
          React.createElement(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.04)"}),
          React.createElement(XAxis,{dataKey:"month",stroke:C.muted,fontSize:11}),
          React.createElement(YAxis,{stroke:C.muted,fontSize:10,tickFormatter:fmt}),
          React.createElement(Tooltip,{content:React.createElement(TT)}),
          React.createElement(Bar,{dataKey:"–í—ã—Ä—É—á–∫–∞",fill:C.a2,radius:[6,6,0,0]}))))),
    React.createElement('div',{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(280px,1fr))",gap:12,marginTop:4}},
      top.length>0&&React.createElement('div',null,
        React.createElement(Ttl,null,"–¢–æ–ø –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"),
        React.createElement(Card,null,top.map((m,i)=>React.createElement('div',{key:i,style:{display:"flex",alignItems:"center",gap:10,padding:"8px 0",borderBottom:i<top.length-1?`1px solid ${C.border}`:"none"}},
          React.createElement('span',{style:{width:24,height:24,borderRadius:7,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700,fontSize:11,background:i===0?"linear-gradient(135deg,#F1C40F,#F7944A)":"rgba(255,255,255,0.05)",color:i===0?"#fff":C.muted}},i+1),
          React.createElement('span',{style:{flex:1,fontWeight:600,fontSize:13,color:C.text}},m.name),
          React.createElement('span',{style:{fontWeight:700,fontSize:13,color:C.text}},fmt(m.rev)+"‚Ç∏"))))),
      pd.length>0&&React.createElement('div',null,
        React.createElement(Ttl,null,"–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã"),
        React.createElement(Card,null,
          React.createElement(ResponsiveContainer,{width:"100%",height:200},
            React.createElement(PieChart,null,React.createElement(Pie,{data:pd,cx:"50%",cy:"50%",innerRadius:50,outerRadius:85,paddingAngle:2,dataKey:"value"},
              pd.map((_,i)=>React.createElement(Cell,{key:i,fill:pc[i%pc.length]}))),
              React.createElement(Tooltip,{formatter:v=>fmtF(v),contentStyle:{background:"#141425",border:`1px solid ${C.border}`,borderRadius:10}}))),
          React.createElement('div',{style:{display:"flex",flexWrap:"wrap",gap:6,justifyContent:"center"}},
            pd.map((e,i)=>React.createElement('span',{key:i,style:{display:"flex",alignItems:"center",gap:4,fontSize:10,color:C.muted}},
              React.createElement('span',{style:{width:7,height:7,borderRadius:"50%",background:pc[i%pc.length],display:"inline-block"}}),e.name)))))),
    f.length===0&&React.createElement(Card,{style:{textAlign:"center",padding:40,marginTop:20}},React.createElement('p',{style:{color:C.muted}},"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")));
}

// ============ MARKETING ============
function MktPage({data,month}){
  const f=month===-1?data:data.filter(d=>getMonth(d.date)===month);
  const tl=f.reduce((s,d)=>s+d.leads,0),tp=f.reduce((s,d)=>s+d.plan,0),ts=f.reduce((s,d)=>s+d.sales,0);
  const tb=f.reduce((s,d)=>s+d.budget,0),tpr=f.reduce((s,d)=>s+d.profit,0);
  const romi=tb?(tpr/tb*100):0,cpl=tl?f.reduce((s,d)=>s+d.spent,0)/tl:0;

  const rows=month===-1?SM.map((m,i)=>{
    const md=data.filter(d=>getMonth(d.date)===i);if(!md.length)return null;
    const lp=md.reduce((s,d)=>s+d.plan,0),l=md.reduce((s,d)=>s+d.leads,0),sp=md.reduce((s,d)=>s+d.spent,0);
    const sl=md.reduce((s,d)=>s+d.sales,0),bk=md.reduce((s,d)=>s+d.budget,0),pr=md.reduce((s,d)=>s+d.profit,0);
    return{lb:MNAMES[i],plan:lp,leads:l,comp:lp?+(l/lp*100).toFixed(1):0,spent:sp,cpl:l?+(sp/l).toFixed(2):0,
      sales:sl,cps:sl?+(sp/sl).toFixed(2):0,conv:l?+(sl/l*100).toFixed(1):0,profit:pr,budget:bk,romi:bk?+(pr/bk*100).toFixed(1):0};
  }).filter(Boolean):f.map(d=>({lb:d.date,plan:d.plan,leads:d.leads,comp:d.plan?+(d.leads/d.plan*100).toFixed(1):0,
    spent:d.spent,cpl:d.leads?+(d.spent/d.leads).toFixed(2):0,sales:d.sales,cps:d.sales?+(d.spent/d.sales).toFixed(2):0,
    conv:d.leads?+(d.sales/d.leads*100).toFixed(1):0,profit:d.profit,budget:d.budget,romi:d.budget?+(d.profit/d.budget*100).toFixed(1):0}));

  return React.createElement('div',null,
    React.createElement('div',{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:10}},
      React.createElement(KPI,{label:"–õ–∏–¥—ã",value:tl,sub:`–ø–ª–∞–Ω ${tp}`,color:C.a2}),
      React.createElement(KPI,{label:"–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ",value:(tp?tl/tp*100:0).toFixed(0)+"%",color:C.a3}),
      React.createElement(KPI,{label:"–¶–µ–Ω–∞/–ª–∏–¥",value:"$"+cpl.toFixed(2),color:C.a4}),
      React.createElement(KPI,{label:"–ü—Ä–æ–¥–∞–∂–∏",value:ts,color:C.a3}),
      React.createElement(KPI,{label:"–ë—é–¥–∂–µ—Ç",value:fmtF(tb),color:C.a1}),
      React.createElement(KPI,{label:"ROMI",value:romi.toFixed(0)+"%",color:romi>300?C.a3:C.a1})),
    rows.length>0&&React.createElement(React.Fragment,null,
      React.createElement(Ttl,null,"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç"),
      React.createElement(Card,{style:{overflowX:"auto"}},
        React.createElement('table',{style:{width:"100%",fontSize:11.5,color:C.text,minWidth:800}},
          React.createElement('thead',null,React.createElement('tr',{style:{borderBottom:`2px solid ${C.a2}`}},
            ["","–ü–ª–∞–Ω","–õ–∏–¥—ã","–í—ã–ø.%","$","$/–ª–∏–¥","–ü—Ä–æ–¥.","$/–ø—Ä–æ–¥.","–ö–æ–Ω–≤.%","–ü—Ä–∏–±—ã–ª—å","–ë—é–¥–∂–µ—Ç‚Ç∏","ROMI"].map((h,i)=>
              React.createElement('th',{key:i,style:{padding:"8px 6px",textAlign:i?"right":"left",color:C.muted,fontWeight:600,fontSize:10}},h)))),
          React.createElement('tbody',null,rows.map((r,i)=>React.createElement('tr',{key:i,style:{borderBottom:`1px solid ${C.border}`,background:i%2?"rgba(255,255,255,0.015)":"transparent"}},
            React.createElement('td',{style:{padding:"7px 6px",fontWeight:600}},r.lb),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right"}},r.plan),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right",fontWeight:600}},r.leads),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right",color:r.comp>=90?C.a3:r.comp>=75?C.a6:C.a1,fontWeight:600}},r.comp+"%"),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right"}},"$"+r.spent),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right",fontWeight:600}},"$"+r.cpl),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right",fontWeight:600}},r.sales),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right"}},"$"+r.cps),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right",color:r.conv>=75?C.a3:C.a4}},r.conv+"%"),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right",color:r.profit>0?C.a3:C.a1,fontWeight:600}},new Intl.NumberFormat("ru").format(r.profit)+"‚Ç∏"),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right"}},new Intl.NumberFormat("ru").format(r.budget)+"‚Ç∏"),
            React.createElement('td',{style:{padding:"7px 6px",textAlign:"right",fontWeight:700,color:r.romi>400?C.a3:r.romi>200?C.a6:C.a1,fontSize:13}},r.romi+"%"))))))),
    f.length===0&&React.createElement(Card,{style:{textAlign:"center",padding:40,marginTop:20}},React.createElement('p',{style:{color:C.muted}},"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")));
}

// ============ FINANCE ============
function FinPage({sd,ed,md,month}){
  const sf=month===-1?sd:sd.filter(d=>getMonth(d.date)===month);
  const ef=month===-1?ed:ed.filter(d=>getMonth(d.date)===month);
  const mf=month===-1?md:md.filter(d=>getMonth(d.date)===month);
  const rev=sf.reduce((s,d)=>s+d.total,0),exp=ef.reduce((s,d)=>s+d.amount,0),tgt=mf.reduce((s,d)=>s+d.budget,0);
  const net=rev-exp-tgt;
  const cats={};ef.forEach(d=>{cats[d.category||"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"]=(cats[d.category||"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"]||0)+d.amount;});
  const cc=[C.a1,C.a2,C.a3,C.a4,C.a5,C.a6,"#95A5A6"];
  const pd=Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([n,v])=>({name:n,value:v}));
  const pm=SM.map((m,i)=>{const sr=sd.filter(d=>getMonth(d.date)===i).reduce((s,d)=>s+d.total,0),er=ed.filter(d=>getMonth(d.date)===i).reduce((s,d)=>s+d.amount,0),
    tr=md.filter(d=>getMonth(d.date)===i).reduce((s,d)=>s+d.budget,0);if(!sr&&!er)return null;return{month:m,–í—ã—Ä—É—á–∫–∞:sr,–†–∞—Å—Ö–æ–¥—ã:er+tr,–ü—Ä–∏–±—ã–ª—å:sr-er-tr};}).filter(Boolean);

  return React.createElement('div',null,
    React.createElement('div',{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:10}},
      React.createElement(KPI,{label:"–í—ã—Ä—É—á–∫–∞",value:fmt(rev)+"‚Ç∏",color:C.a2}),
      React.createElement(KPI,{label:"–†–∞—Å—Ö–æ–¥—ã",value:fmt(exp)+"‚Ç∏",color:C.a1}),
      React.createElement(KPI,{label:"–¢–∞—Ä–≥–µ—Ç",value:fmt(tgt)+"‚Ç∏",color:C.a6}),
      React.createElement(KPI,{label:"–ü—Ä–∏–±—ã–ª—å",value:fmt(net)+"‚Ç∏",sub:rev?`–º–∞—Ä–∂–∞ ${(net/rev*100).toFixed(0)}%`:"",color:net>0?C.a3:C.a1})),
    React.createElement('div',{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(280px,1fr))",gap:12,marginTop:4}},
      pd.length>0&&React.createElement('div',null,React.createElement(Ttl,null,"–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"),
        React.createElement(Card,null,React.createElement(ResponsiveContainer,{width:"100%",height:200},
          React.createElement(PieChart,null,React.createElement(Pie,{data:pd,cx:"50%",cy:"50%",innerRadius:50,outerRadius:85,paddingAngle:2,dataKey:"value"},
            pd.map((_,i)=>React.createElement(Cell,{key:i,fill:cc[i%cc.length]}))),
            React.createElement(Tooltip,{formatter:v=>fmtF(v),contentStyle:{background:"#141425",border:`1px solid ${C.border}`,borderRadius:10}}))),
          React.createElement('div',{style:{display:"flex",flexWrap:"wrap",gap:5,justifyContent:"center"}},
            pd.map((e,i)=>React.createElement('span',{key:i,style:{display:"flex",alignItems:"center",gap:3,fontSize:10,color:C.muted}},
              React.createElement('span',{style:{width:6,height:6,borderRadius:"50%",background:cc[i%cc.length],display:"inline-block"}}),e.name))))),
      pm.length>0&&React.createElement('div',null,React.createElement(Ttl,null,"–ü—Ä–∏–±—ã–ª—å –ø–æ –º–µ—Å—è—Ü–∞–º"),
        React.createElement(Card,null,React.createElement(ResponsiveContainer,{width:"100%",height:220},
          React.createElement(BarChart,{data:pm},
            React.createElement(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.04)"}),
            React.createElement(XAxis,{dataKey:"month",stroke:C.muted,fontSize:11}),
            React.createElement(YAxis,{stroke:C.muted,fontSize:10,tickFormatter:fmt}),
            React.createElement(Tooltip,{content:React.createElement(TT)}),
            React.createElement(Legend,{wrapperStyle:{fontSize:11}}),
            React.createElement(Bar,{dataKey:"–í—ã—Ä—É—á–∫–∞",fill:C.a2,radius:[5,5,0,0]}),
            React.createElement(Bar,{dataKey:"–†–∞—Å—Ö–æ–¥—ã",fill:C.a1,radius:[5,5,0,0]}),
            React.createElement(Bar,{dataKey:"–ü—Ä–∏–±—ã–ª—å",fill:C.a3,radius:[5,5,0,0]})))))));
}

// ============ MAIN ============
function App(){
  const [cfg,setCfg]=useState({astanaId:"",almatyId:""});
  const [ok,setOk]=useState(false);
  const [loading,setLoading]=useState(false);
  const [sd,setSd]=useState([]);const [ed,setEd]=useState([]);const [md,setMd]=useState([]);
  const [tab,setTab]=useState("sales");const [city,setCity]=useState("–í—Å–µ");const [month,setMonth]=useState(-1);
  const [lu,setLu]=useState(null);

  useEffect(()=>{try{const s=localStorage.getItem("flower-cfg");if(s){setCfg(JSON.parse(s));}}catch{};},[]);

  const fetchData=useCallback(async(c)=>{
    setLoading(true);
    try{
      const as=[],ae=[],am=[];
      for(const[cn,id]of[["–ê—Å—Ç–∞–Ω–∞",c.astanaId],["–ê–ª–º–∞—Ç—ã",c.almatyId]]){
        if(!id)continue;
        try{const r=await fetch(SHEETS_URL(id,"–ü—Ä–æ–¥–∞–∂–∏"));if(r.ok){const rows=parseCSV(await r.text());
          rows.forEach(r=>{const k=Object.keys(r);
            as.push({city:cn,date:r[k[0]],name:r[k[1]],shift:r[k[2]],leads:num(r[k[3]]),orders:num(r[k[4]]),
              kp:num(r[k[5]]),kr:num(r[k[6]]),ca:num(r[k[7]]),hk:num(r[k[8]])+num(r[k[9]]),
              ot:num(r[k[10]])+num(r[k[11]])+num(r[k[12]])+num(r[k[13]])+num(r[k[14]])+num(r[k[15]])+num(r[k[16]]),
              total:num(r[k[19]])});});}}catch(e){console.warn(e);}
        try{const r=await fetch(SHEETS_URL(id,"–†–∞—Å—Ö–æ–¥—ã"));if(r.ok){const rows=parseCSV(await r.text());
          rows.forEach(r=>{const k=Object.keys(r);ae.push({city:cn,date:r[k[0]],name:r[k[1]],amount:num(r[k[2]]),category:r[k[3]]||"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"});});}}catch(e){console.warn(e);}
        try{const r=await fetch(SHEETS_URL(id,"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥"));if(r.ok){const rows=parseCSV(await r.text());
          rows.forEach(r=>{const k=Object.keys(r);am.push({city:cn,date:r[k[0]],plan:num(r[k[1]]),leads:num(r[k[2]]),
            spent:num(r[k[4]]),sales:num(r[k[6]]),profit:num(r[k[9]]),budget:num(r[k[11]])});});}}catch(e){console.warn(e);}
      }
      setSd(as.filter(d=>d.date));setEd(ae.filter(d=>d.date));setMd(am.filter(d=>d.date));setLu(new Date());
    }catch(e){console.error(e);}
    setLoading(false);
  },[]);

  const save=c=>{try{localStorage.setItem("flower-cfg",JSON.stringify(c));}catch{} setOk(true);fetchData(c);};
  useEffect(()=>{if(!ok)return;const i=setInterval(()=>fetchData(cfg),5*60*1000);return()=>clearInterval(i);},[ok,cfg,fetchData]);

  const fs=useMemo(()=>city==="–í—Å–µ"?sd:sd.filter(d=>d.city===city),[sd,city]);
  const fe=useMemo(()=>city==="–í—Å–µ"?ed:ed.filter(d=>d.city===city),[ed,city]);
  const fm=useMemo(()=>city==="–í—Å–µ"?md:md.filter(d=>d.city===city),[md,city]);
  const avM=useMemo(()=>{const s=new Set();sd.forEach(d=>{const m=getMonth(d.date);if(m>=0)s.add(m);});return[...s].sort();},[sd]);

  if(!ok)return React.createElement(Settings,{config:cfg,setConfig:setCfg,onSave:save});

  return React.createElement('div',{style:{maxWidth:1100,margin:"0 auto",padding:"16px 14px 0"}},
    React.createElement('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:10,marginBottom:14}},
      React.createElement('div',null,
        React.createElement('h1',{style:{fontSize:20,fontWeight:800,margin:0,background:"linear-gradient(135deg,#E8446D,#F7944A)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}},"üå∏ Flower Dashboard"),
        lu&&React.createElement('p',{style:{color:C.muted,fontSize:10,margin:"3px 0 0"}},"–û–±–Ω–æ–≤–ª–µ–Ω–æ: ",lu.toLocaleTimeString("ru")," ‚Ä¢ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 5 –º–∏–Ω")),
      React.createElement('div',{style:{display:"flex",gap:5,flexWrap:"wrap",alignItems:"center"}},
        ["–í—Å–µ","–ê—Å—Ç–∞–Ω–∞","–ê–ª–º–∞—Ç—ã"].map(c=>React.createElement('button',{key:c,onClick:()=>setCity(c),style:{
          padding:"6px 13px",borderRadius:8,border:"1px solid",fontSize:11.5,fontWeight:600,cursor:"pointer",
          background:city===c?(c==="–í—Å–µ"?`linear-gradient(135deg,${C.a1},${C.a4})`:c==="–ê—Å—Ç–∞–Ω–∞"?C.a2:C.a1):"transparent",
          borderColor:city===c?"transparent":C.border,color:city===c?"#fff":C.muted}},c)),
        React.createElement('select',{value:month,onChange:e=>setMonth(+e.target.value),style:{
          padding:"6px 8px",borderRadius:8,border:`1px solid ${C.border}`,fontSize:11.5,background:"#141425",color:C.text,cursor:"pointer",outline:"none"}},
          React.createElement('option',{value:-1},"–í—Å–µ –º–µ—Å—è—Ü—ã"),
          avM.map(m=>React.createElement('option',{key:m,value:m},MNAMES[m]))),
        React.createElement('button',{onClick:()=>fetchData(cfg),style:{padding:"6px 12px",borderRadius:8,border:`1px solid ${C.border}`,background:"transparent",color:C.a3,cursor:"pointer",fontSize:11.5,fontWeight:600}},loading?"‚è≥":"üîÑ"),
        React.createElement('button',{onClick:()=>setOk(false),style:{padding:"6px 10px",borderRadius:8,border:`1px solid ${C.border}`,background:"transparent",color:C.muted,cursor:"pointer",fontSize:11}},"‚öôÔ∏è"))),
    React.createElement('div',{style:{display:"flex",gap:0,borderBottom:`2px solid ${C.border}`,marginBottom:18}},
      [{id:"sales",l:"–ü—Ä–æ–¥–∞–∂–∏",i:"üìä"},{id:"marketing",l:"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥",i:"üéØ"},{id:"finance",l:"–§–∏–Ω–∞–Ω—Å—ã",i:"üí∞"}].map(t=>
        React.createElement('button',{key:t.id,onClick:()=>setTab(t.id),style:{padding:"10px 20px",border:"none",cursor:"pointer",fontSize:13,fontWeight:700,
          background:"transparent",color:tab===t.id?C.text:C.muted,borderBottom:tab===t.id?`3px solid ${C.a1}`:"3px solid transparent",marginBottom:-2}},t.i," ",t.l))),
    loading&&sd.length===0?React.createElement(Card,{style:{textAlign:"center",padding:60}},React.createElement('p',{style:{color:C.muted,fontSize:16}},"‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...")):
    React.createElement('div',{style:{paddingBottom:50}},
      tab==="sales"&&React.createElement(SalesPage,{data:fs,month}),
      tab==="marketing"&&React.createElement(MktPage,{data:fm,month}),
      tab==="finance"&&React.createElement(FinPage,{sd:fs,ed:fe,md:fm,month})));
}

ReactDOM.render(React.createElement(App), document.getElementById('root'));
</script>
</body>
</html>
